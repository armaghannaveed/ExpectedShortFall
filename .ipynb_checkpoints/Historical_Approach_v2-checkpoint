{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "a507bdc0-9e4c-4015-8245-b0cb936e57c7",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Import standard libraries\n",
    "import matplotlib.pyplot as plt\n",
    "from datetime import datetime\n",
    "import pandas as pd\n",
    "import random\n",
    "import numpy as np\n",
    "import yfinance as yf # ticker data \n",
    "from pandas_datareader import data as pdr # market proxy and treasury rates data\n",
    "import datetime as dt\n",
    "from numpy import nan\n",
    "from time import sleep\n",
    "import concurrent.futures\n",
    "from functools import reduce\n",
    "from scipy.stats import norm\n",
    "from sklearn.preprocessing import MinMaxScaler\n",
    "from sklearn.metrics import mean_squared_error\n",
    "import scipy \n",
    "import time"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 71,
   "id": "dbc9359a-c334-4e10-9837-26c092c8c778",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "         Permno Ticker        Date   Returns\n",
      "0         10026   JJSF  2022-01-03  0.007344\n",
      "1         10026   JJSF  2022-01-04 -0.003582\n",
      "2         10026   JJSF  2022-01-05 -0.003406\n",
      "3         10026   JJSF  2022-01-06 -0.000316\n",
      "4         10026   JJSF  2022-01-07  0.004052\n",
      "...         ...    ...         ...       ...\n",
      "2391745   93436   TSLA  2022-12-23 -0.017551\n",
      "2391746   93436   TSLA  2022-12-27 -0.114089\n",
      "2391747   93436   TSLA  2022-12-28  0.033089\n",
      "2391748   93436   TSLA  2022-12-29  0.080827\n",
      "2391749   93436   TSLA  2022-12-30  0.011164\n",
      "\n",
      "[2391750 rows x 4 columns]\n"
     ]
    }
   ],
   "source": [
    "from database import DatabaseUBCTG\n",
    "\n",
    "db = DatabaseUBCTG()\n",
    "\n",
    "df = db.get_returns_universe(start=\"2022-01-01\", end=\"2022-12-31\")\n",
    "\n",
    "print(df)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 193,
   "id": "214a85a7-97d8-4309-b5a9-4bf1c3218977",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Convert the date column to datetime if it's not already\n",
    "# df['Date'] = pd.to_datetime(df['Date'])\n",
    "\n",
    "# Filter out rows before January 1, 2022\n",
    "# filtered_df = df[df['Date'] >= '2022-01-01']\n",
    "\n",
    "# Filter out rows that don't have data from December 30, 2022\n",
    "# filtered_df = df[df['Date'] == '2022-12-30']"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 194,
   "id": "be487908-2769-404e-8f38-f30f5d2d3ae5",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "['JJSF' 'ELA' 'PLXS' ... 'CBOE' 'SANW' 'TSLA']\n",
      "10285\n"
     ]
    }
   ],
   "source": [
    "unique_tickers = df['Ticker'].unique()\n",
    "print((unique_tickers))\n",
    "print(len(unique_tickers))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 224,
   "id": "d4194856-9d4d-456c-9579-d7cbdd2d6114",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Convert the date column to datetime if it's not already\n",
    "df['Date'] = pd.to_datetime(df['Date'])\n",
    "\n",
    "# Create a mask for tickers with 0 or NaN values between Jan 1, 2022, and Dec 30, 2022\n",
    "mask = ((df['Date'] >= '2022-01-01') & (df['Date'] <= '2022-12-30')) & (df.isin([np.nan]).any(axis=1))\n",
    "\n",
    "# Get tickers to filter out\n",
    "tickers_to_filter = df[mask]['Ticker'].unique()\n",
    "\n",
    "# Filter the DataFrame to exclude rows with tickers having NaN values\n",
    "filtered_df = df[~df['Ticker'].isin(tickers_to_filter)]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 225,
   "id": "5c83ad82-357f-47f7-a970-73cec88f36b9",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "['RSXJ' None 'AMPE' 'YNDX' 'AREN' 'PME' 'QIWI' 'BLUE' 'AAMC' 'TMBR' 'MESO'\n",
      " 'EVTV' 'ONE' 'BBIG' 'HHR' 'CCAC' 'OPT' 'OZON' 'BTMD' 'AFAQ' 'PLL' 'GDEV'\n",
      " 'ARBK' 'AHI' 'CIAN' 'RESI' 'HOTL' 'TPG' 'FGI' 'CRDO' 'CEG' 'ALOR' 'ALSA'\n",
      " 'AMLX' 'APCX' 'APXI' 'AZ' 'BIOS' 'BLEU' 'BOCN' 'BPAC' 'BRFH' 'BRKH'\n",
      " 'CFSB' 'CINC' 'CISO' 'CMCA' 'CNGL' 'CREC' 'DAOO' 'DCFC' 'DMAT' 'ENCP'\n",
      " 'FEXD' 'FXCO' 'GDNR' 'GEEX' 'GFGD' 'GGAA' 'HAIA' 'HILS' 'HORI' 'HOUR'\n",
      " 'IDAI' 'IGTA' 'IOAC' 'JWAC' 'KACL' 'KSCP' 'LFAC' 'LGST' 'MAAQ' 'NSTS'\n",
      " 'NVAC' 'NZRO' 'OLIT' 'RNER' 'ROCL' 'SATL' 'TCHI' 'TGAA' 'TKLF' 'TLGY'\n",
      " 'UMMA' 'UTAA' 'VHNA' 'VIGL' 'VMGA' 'WTMA' 'XDNA' 'XPDB' 'ZING' 'SAMT'\n",
      " 'SAGP' 'SIXJ' 'AVSC' 'ATEK' 'BRD' 'CWC' 'FLTN' 'RSEE' 'TRDF' 'DMA' 'EVEN'\n",
      " 'ONG' 'FNTC' 'WEIX' 'SEA' 'MNTN' 'BNGE' 'GAST' 'XDJA' 'XTJA' 'XBJA'\n",
      " 'QTJA' 'IRRX' 'RJAC' 'JBBB' 'FLDZ' 'NETC' 'IUSA' 'PAXS' 'PACI' 'REMG'\n",
      " 'RDMX' 'ESIX' 'PUNK' 'SUAC' 'EAFD' 'EMGD' 'RTYD' 'PORT' 'UPAR' 'TCOA'\n",
      " 'VZLA' 'IFIN' 'NFNT' 'WEL' 'MTVC' 'SCUA' 'STET' 'SGHC' 'ZIMV' 'ACLX'\n",
      " 'AHRN' 'AIB' 'ANGH' 'AOGO' 'AREB' 'BRAC' 'BWV' 'CEAD' 'CFFS' 'CITE'\n",
      " 'COSM' 'DRCT' 'EMLD' 'FRBN' 'GMFI' 'HTCR' 'IVCB' 'IVCP' 'IXHL' 'LSPR'\n",
      " 'MHUA' 'MODD' 'MTEK' 'NVCT' 'NVX' 'PABU' 'PRLH' 'RCAC' 'SAGA' 'SBFM'\n",
      " 'SCRM' 'SKYX' 'SMFL' 'SSIC' 'SZZL' 'TCBP' 'TGAN' 'VBOC' 'VIVK' 'WGMI'\n",
      " 'LETB' 'IWIN' 'ADRT' 'BRCC' 'BRBR' 'XHYE' 'XHYC' 'XHYD' 'XHYF' 'XHYH'\n",
      " 'XHYT' 'XHYI' 'BFIX' 'CXAC' 'CGXU' 'CGGR' 'CGUS' 'CGDV' 'CGGO' 'CGCP'\n",
      " 'RLTY' 'HYRM' 'DFSV' 'DFAR' 'DUHP' 'GFOF' 'PSYK' 'NETZ' 'FSYD' 'DJIA'\n",
      " 'GEMD' 'GCLN' 'WINN' 'HGER' 'HAPY' 'WRND' 'LRND' 'MRND' 'BUFB' 'CSH'\n",
      " 'IRBA' 'MDV' 'RMMZ' 'PRAY' 'HYBL' 'AGGH' 'CDX' 'CLSE' 'DGIN' 'WBAT'\n",
      " 'APCA' 'BFAC' 'EVE' 'SHAP' 'EMBC' 'ESAB' 'ACAB' 'ACAX' 'AKAN' 'ANTX'\n",
      " 'ASCA' 'ATAK' 'BWAQ' 'CSLM' 'DAM' 'DRTS' 'DUET' 'EKG' 'FEAM' 'GHIX'\n",
      " 'GMGI' 'HCMA' 'ITAQ' 'KYCH' 'LATG' 'LCFY' 'LIVB' 'MURF' 'POET' 'PPYA'\n",
      " 'RVSN' 'SGHL' 'TETE' 'ZTEK' 'ROCI' 'AVSU' 'AVSD' 'AVSE' 'BYN' 'RHCB'\n",
      " 'BBUC' 'TACK' 'SEMI' 'DO' 'DIHP' 'DFIS' 'DISV' 'DFIC' 'MSTQ' 'EP' 'CRIT'\n",
      " 'GLOV' 'HMA' 'PSTP' 'BSTP' 'CHGX' 'IBHI' 'IBHH' 'TGR' 'KNSW' 'KGHG'\n",
      " 'IPDP' 'IPPP' 'MGLD' 'IDR' 'GDVD' 'VERS' 'CTA' 'STRY' 'HAUS' 'RPHS'\n",
      " 'OACP' 'SVIX' 'UVIX' 'GDE' 'AXAC' 'WNNR' 'GAQ' 'PGRU' 'VCXB' 'ALLG' 'WBD'\n",
      " 'EE' 'UAV' 'CRYP' 'DFEM' 'DFEV' 'DEHP' 'TIPD' 'TIPL' 'DNBD' 'DCPE' 'INQQ'\n",
      " 'FSLD' 'FSBD' 'FEEM' 'GUSA' 'HNRA' 'IBLC' 'JCPI' 'DC' 'KSET' 'WEED'\n",
      " 'NBCT' 'NBDS' 'NBCC' 'FMCX' 'SUPL' 'MBNE' 'URNM' 'GNS' 'ACON' 'ARVR'\n",
      " 'BLTE' 'BYNO' 'CLIN' 'CPAQ' 'CRGE' 'ELBM' 'EVGR' 'EVMT' 'FDIG' 'FGMC'\n",
      " 'FMET' 'FTII' 'GDST' 'GENQ' 'GGR' 'GRNR' 'GSRM' 'HLVX' 'IVDA' 'IVEG'\n",
      " 'JCSE' 'JGGC' 'JMSB' 'LBBB' 'NUTX' 'NZUS' 'ODDS' 'OST' 'PWUP' 'RACY'\n",
      " 'RFAC' 'RWOD' 'SHUA' 'SOUN' 'SPCM' 'STSS' 'SWVL' 'TNON' 'VMCA' 'VR'\n",
      " 'WAVS' 'XPON' 'AZPN' 'PFHC' 'BGXX' 'MNBD' 'MOOD' 'AUST' 'BLCO' 'XBB' 'XB'\n",
      " 'XCCC' 'DFUV' 'MPAY' 'GABF' 'GDIV' 'IAUX' 'JMEE' 'JPRE' 'TILL' 'STGF'\n",
      " 'ODV' 'PFRL' 'BYRE' 'LQIG' 'SEIQ' 'SEIM' 'SEIV' 'SELV' 'FIG' 'ORFN'\n",
      " 'ASCB' 'ASNS' 'BCAN' 'BNRG' 'BULD' 'CMRA' 'DECA' 'EDBL' 'HNVR' 'JEPQ'\n",
      " 'MSSA' 'NUBI' 'OKYO' 'PEPG' 'PLAO' 'PRE' 'SOBR' 'SWEB' 'TARK' 'TUG'\n",
      " 'TUGN' 'TYDE' 'VEDU' 'EHAB' 'OGIG' 'OEUR' 'OUSA' 'OUSM' 'XEMD' 'USNZ'\n",
      " 'BRKY' 'BUFQ' 'FGLD' 'IWFG' 'IWLG' 'AGIH' 'AGRH' 'HYGI' 'IBDX' 'IE'\n",
      " 'JIRE' 'VMAT' 'SHPP' 'TRFK' 'LONZ' 'BITI' 'OAIE' 'SYII' 'GVLU' 'CPII'\n",
      " 'AHOY' 'UDI' 'NIWM' 'NSPY' 'CLOI' 'WDS' 'AFAR' 'AFRI' 'ALVO' 'AOTG'\n",
      " 'CHEA' 'CLRC' 'CNXA' 'CZFS' 'FEMA' 'GBBK' 'GSUN' 'HSCS' 'INTR' 'IONR'\n",
      " 'IPX' 'IVCA' 'KAL' 'LYT' 'NTZG' 'PEV' 'PGY' 'PSNY' 'PSNYW' 'RENE' 'SVRE'\n",
      " 'TOP' 'YOTA' 'USEA' 'HKD' 'TRFM' 'GETY' 'IRHG' 'IRVH' 'HLN' 'RENW' 'MMSB'\n",
      " 'TSLH' 'SPCZ' 'MAIA' 'MEM' 'MINV' 'MCH' 'SSXU' 'SIO' 'LCF' 'ECBK' 'FIP'\n",
      " 'GRRR' 'GWAV' 'IBTM' 'ILAG' 'MCAC' 'MGAM' 'NCPL' 'NEOV' 'NKEL' 'NKEQ'\n",
      " 'NVDS' 'PFEL' 'PFES' 'PMN' 'PNAC' 'PYPS' 'PYPT' 'TSLQ' 'VRAX' 'WETG'\n",
      " 'CHG' 'FRZA' 'REBN' 'LUCY' 'ACAC' 'MCVT' 'QBTS' 'FLFV' 'NCRA' 'TGL'\n",
      " 'EFSH' 'ONFO' 'PXMD' 'WEST' 'HPCO' 'SHPH' 'ATXG' 'MSOX' 'LCLG' 'DRLL'\n",
      " 'NDIV' 'BPAY' 'SPKY' 'SPKX' 'EVAV' 'GRFX' 'XUSP' 'FOMO' 'LQDW' 'HYGW'\n",
      " 'TLTW' 'IBRN' 'JGRO' 'BCDF' 'FDLS' 'SPYI' 'BNDI' 'CSHI' 'STCE' 'SESG'\n",
      " 'AZTD' 'DVND' 'TUSI' 'TFPM' 'CGV' 'BIAF' 'AAPB' 'AAPD' 'AAPU' 'AMID'\n",
      " 'BRSH' 'CONL' 'DSPC' 'GCT' 'JFBR' 'JZ' 'MEGL' 'MOB' 'PDBA' 'SARK' 'SKGR'\n",
      " 'SOGU' 'STBX' 'TBIL' 'TSL' 'TSLI' 'TSLL' 'TSLS' 'TWEB' 'UTEN' 'UTWO'\n",
      " 'CRBG' 'XPER' 'NE' 'BHM' 'YEAR' 'TAFI' 'STRV' 'AVGE' 'AVIE' 'IDVO' 'AMPX'\n",
      " 'XHLF' 'XTWY' 'XTEN' 'XSVN' 'XFIV' 'XTRE' 'XTWO' 'XONE' 'KARB' 'EMCA'\n",
      " 'EMGC' 'EMZA' 'EMCH' 'EMPW' 'KPOP' 'XSEP' 'OSEA' 'INLX' 'NXTE' 'JHDV'\n",
      " 'KNW' 'KDIV' 'LVWR' 'LPTV' 'MPTI' 'BUYW' 'PBDC' 'SYNB' 'DEFI' 'THLV'\n",
      " 'SDGS' 'NOPE' 'OAIM' 'OAEM' 'XC' 'BHVN' 'ALPS' 'AMV' 'AMZD' 'AMZU' 'BLLD'\n",
      " 'BSCW' 'BSJU' 'CCSO' 'CIRC' 'DIVD' 'EMCG' 'GGLL' 'GGLS' 'HMAC' 'IBIT'\n",
      " 'IWTR' 'LASE' 'LNKB' 'MAXI' 'MOBV' 'MSFD' 'MSFU' 'NXL' 'NYAX' 'PTWO'\n",
      " 'SILO' 'THCH' 'THRD' 'UPWD' 'WLDS' 'YOSH' 'PRME' 'RXO' 'BRNY' 'DVAL'\n",
      " 'FTGS' 'MBLY' 'MCSE' 'MODL' 'QQQS' 'RNEW' 'SLNA' 'SVII' 'VOXR' 'AQU'\n",
      " 'SDSI' 'SHOC' 'BBLU' 'UYLD' 'BWEB' 'BRLN' 'BMN' 'CGMU' 'CGMS' 'CGSD'\n",
      " 'CTM' 'SRHQ' 'DSMC' 'EFXT' 'MISL' 'RDVI' 'XCOR' 'XNAV' 'RYLG' 'GRNT'\n",
      " 'HAPI' 'IQSM' 'IQHI' 'AAA' 'KMET' 'NBCM' 'RTO' 'SCMB' 'HIGH' 'BUCK'\n",
      " 'THYF' 'TSME' 'HFND' 'YALL' 'SHDG' 'NSPL' 'SMOT' 'MNK' 'PERF' 'SATX'\n",
      " 'UHALB' 'FG' 'DMYY' 'FSCO' 'ASPI' 'ACRV' 'GLST' 'QOMO' 'SNAL' 'CMND'\n",
      " 'NWTN' 'NAMS' 'DRS' 'ATAT' 'EFRA' 'ERET' 'OBIL' 'STXD' 'STXG' 'STXK'\n",
      " 'STXV' 'RVRB' 'NVBW' 'NVBT' 'HIDE' 'CARY' 'BKGI' 'SNPG' 'SNPV' 'SNPD'\n",
      " 'DFSB' 'DFSE' 'DFSI' 'DFSU' 'JUCY' 'FDV' 'EIPX' 'TYLG' 'HYLG' 'FYLG'\n",
      " 'MEDI' 'IGTR' 'SFLR' 'TGN' 'HDUS' 'ADPV' 'TUA' 'TFLR' 'PP' 'FIAX' 'OARK'\n",
      " 'TSLY' 'INC' 'MBC' 'BAM' 'ARP' 'DECW' 'DECT' 'BOXX' 'DFGR' 'DFLV' 'DIP'\n",
      " 'STNC' 'ICLO' 'ISDB' 'IMSI' 'HIYS' 'WUGI' 'JHID' 'OAIA' 'RNWZ' 'INTL'\n",
      " 'PBL' 'PJFV' 'PJFG' 'ION' 'CHRG' 'SANE' 'KCAL' 'DKRB' 'SECD' 'FCUS'\n",
      " 'QVOY' 'EQTY' 'PIT' 'VEMY' 'QGRW' 'LANV' 'MRDB' 'BABX' 'CACO' 'COWG'\n",
      " 'COYA' 'ECX' 'EFHT' 'FBL' 'HUDA' 'INFR' 'JEWL' 'KWE' 'LIPO' 'NVDL' 'OSA'\n",
      " 'RAYA' 'TENK' 'POCI' 'CVU' 'DPSI' 'TLF' 'SCWO' 'AIMD' 'SOFO' 'MICS'\n",
      " 'APLD' 'CYTK' 'SVA' 'OBE' 'ASTI' 'ESOA' 'FFHL' 'RSX' 'CO' 'SDRL']\n",
      "867\n"
     ]
    }
   ],
   "source": [
    "print(tickers_to_filter)\n",
    "print(len(tickers_to_filter))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 226,
   "id": "feff3a8a-2722-46a1-afac-afdd4183bb1b",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "         Permno Ticker       Date   Returns\n",
      "0         10026   JJSF 2022-01-03  0.007344\n",
      "1         10026   JJSF 2022-01-04 -0.003582\n",
      "2         10026   JJSF 2022-01-05 -0.003406\n",
      "3         10026   JJSF 2022-01-06 -0.000316\n",
      "4         10026   JJSF 2022-01-07  0.004052\n",
      "...         ...    ...        ...       ...\n",
      "2391745   93436   TSLA 2022-12-23 -0.017551\n",
      "2391746   93436   TSLA 2022-12-27 -0.114089\n",
      "2391747   93436   TSLA 2022-12-28  0.033089\n",
      "2391748   93436   TSLA 2022-12-29  0.080827\n",
      "2391749   93436   TSLA 2022-12-30  0.011164\n",
      "\n",
      "[2261755 rows x 4 columns]\n"
     ]
    }
   ],
   "source": [
    "print(filtered_df)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 227,
   "id": "664d40a8-9384-42d8-a8bf-503d2da9a337",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\joshl\\AppData\\Local\\Temp/ipykernel_39852/320379466.py:2: SettingWithCopyWarning: \n",
      "A value is trying to be set on a copy of a slice from a DataFrame.\n",
      "Try using .loc[row_indexer,col_indexer] = value instead\n",
      "\n",
      "See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n",
      "  filtered_df['Date'] = pd.to_datetime(filtered_df['Date'])\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Ticker             A        AA      AAAU       AAC      AACG      AACI  \\\n",
      "Date                                                                     \n",
      "2022-01-03 -0.018541  0.013092 -0.014851  0.002053  0.111630  0.012257   \n",
      "2022-01-04 -0.033806 -0.046885  0.007817  0.002049  1.142857 -0.001009   \n",
      "2022-01-05 -0.017131  0.017730 -0.002770  0.001022 -0.098039 -0.005051   \n",
      "2022-01-06  0.003499 -0.001708 -0.012778 -0.003064 -0.139130 -0.005076   \n",
      "2022-01-07 -0.026623  0.067066  0.005065  0.001025  0.333333  0.007143   \n",
      "...              ...       ...       ...       ...       ...       ...   \n",
      "2022-12-23  0.001476  0.007982  0.003093 -0.000992 -0.006897  0.001992   \n",
      "2022-12-27  0.002144  0.014932  0.008410  0.001986 -0.055556  0.000000   \n",
      "2022-12-28 -0.009763 -0.023629 -0.004726 -0.000991 -0.039044  0.003976   \n",
      "2022-12-29  0.020258  0.063014  0.005866  0.000992  0.032979  0.007921   \n",
      "2022-12-30 -0.008042 -0.023411  0.004721 -0.001982 -0.056815 -0.005894   \n",
      "\n",
      "Ticker          AADI      AADR      AAIC       AAL  ...       ZUO      ZVIA  \\\n",
      "Date                                                ...                       \n",
      "2022-01-03  0.033954  0.002524  0.017143  0.043987  ... -0.017666  0.060993   \n",
      "2022-01-04 -0.019223 -0.000360  0.005618  0.014400  ... -0.019619 -0.017380   \n",
      "2022-01-05 -0.073499 -0.016128 -0.013966 -0.017876  ... -0.067815 -0.002721   \n",
      "2022-01-06 -0.004848  0.004795  0.014164 -0.005889  ... -0.014311 -0.055935   \n",
      "2022-01-07 -0.036758  0.002116  0.002793  0.038234  ...  0.000000  0.001445   \n",
      "...              ...       ...       ...       ...  ...       ...       ...   \n",
      "2022-12-23 -0.007924  0.005986  0.007018  0.011943  ...  0.021127 -0.016529   \n",
      "2022-12-27 -0.042332 -0.011618 -0.003484 -0.014162  ...  0.006897 -0.002801   \n",
      "2022-12-28  0.003336 -0.005038 -0.010490 -0.016760  ...  0.010274  0.036517   \n",
      "2022-12-29  0.045719  0.007595  0.031802  0.030844  ...  0.084746  0.119241   \n",
      "2022-12-30  0.019873  0.000000  0.003425  0.001575  ... -0.006250 -0.009685   \n",
      "\n",
      "Ticker           ZVO      ZVSA      ZWRK       ZWS        ZY      ZYME  \\\n",
      "Date                                                                     \n",
      "2022-01-03  0.102362       NaN -0.001027 -0.003846  0.049327  0.035998   \n",
      "2022-01-04  0.014286       NaN -0.001028  0.019857 -0.089744 -0.045936   \n",
      "2022-01-05 -0.021127       NaN  0.002058 -0.035965 -0.109546 -0.067901   \n",
      "2022-01-06 -0.057554       NaN  0.001027 -0.004208  0.001757 -0.068212   \n",
      "2022-01-07 -0.007634       NaN  0.000000 -0.023380 -0.001754  0.002843   \n",
      "...              ...       ...       ...       ...       ...       ...   \n",
      "2022-12-23       NaN -0.115226       NaN  0.005631       NaN -0.085324   \n",
      "2022-12-27       NaN -0.104651       NaN  0.005600       NaN -0.068408   \n",
      "2022-12-28       NaN -0.137662       NaN -0.014849       NaN  0.000000   \n",
      "2022-12-29       NaN -0.066265       NaN  0.027320       NaN  0.042724   \n",
      "2022-12-30       NaN  0.012903       NaN -0.030261       NaN  0.006402   \n",
      "\n",
      "Ticker          ZYNE      ZYXI  \n",
      "Date                            \n",
      "2022-01-03  0.048611  0.032096  \n",
      "2022-01-04 -0.023179 -0.025267  \n",
      "2022-01-05 -0.091525  0.029910  \n",
      "2022-01-06  0.007463 -0.045161  \n",
      "2022-01-07 -0.003704 -0.046171  \n",
      "...              ...       ...  \n",
      "2022-12-23 -0.000185  0.015441  \n",
      "2022-12-27 -0.073903 -0.003621  \n",
      "2022-12-28  0.031400  0.008721  \n",
      "2022-12-29  0.099283 -0.000720  \n",
      "2022-12-30 -0.065091  0.002884  \n",
      "\n",
      "[251 rows x 9418 columns]\n"
     ]
    }
   ],
   "source": [
    "# Convert the date column to datetime if it's not already\n",
    "filtered_df['Date'] = pd.to_datetime(filtered_df['Date'])\n",
    "\n",
    "# Use pivot_table with aggregation (mean) to handle duplicates\n",
    "pivot_df = filtered_df.pivot_table(index='Date', columns='Ticker', values='Returns', aggfunc='mean')\n",
    "\n",
    "# Now pivot_df is a matrix where columns represent different tickers and rows represent different days\n",
    "print(pivot_df)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 228,
   "id": "8e11556a-b618-4918-a307-2130561235f6",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n"
     ]
    }
   ],
   "source": [
    "print(type(pivot_df))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 229,
   "id": "f12d828e-4b70-4173-9466-6ec958a990a8",
   "metadata": {},
   "outputs": [],
   "source": [
    "matrix_data = pivot_df.values"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 220,
   "id": "494287ac-d439-44c7-a67b-d82ef8c7c360",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[[10026 'JJSF' Timestamp('2022-01-03 00:00:00') 0.007344]\n",
      " [10026 'JJSF' Timestamp('2022-01-04 00:00:00') -0.003582]\n",
      " [10026 'JJSF' Timestamp('2022-01-05 00:00:00') -0.003406]\n",
      " ...\n",
      " [93436 'TSLA' Timestamp('2022-12-28 00:00:00') 0.033089]\n",
      " [93436 'TSLA' Timestamp('2022-12-29 00:00:00') 0.080827]\n",
      " [93436 'TSLA' Timestamp('2022-12-30 00:00:00') 0.011164]]\n"
     ]
    }
   ],
   "source": [
    "print(matrix_data)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 221,
   "id": "5d06851a-6cad-4c1a-9a1c-59cd932ae52f",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "93436\n"
     ]
    }
   ],
   "source": [
    "# matrix_data[day][ticker]\n",
    "print(matrix_data[-1][-4])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 207,
   "id": "d56dca46-be2b-40ed-b59f-616ccc3eff6c",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Function that does everything above:\n",
    "def convert(df):\n",
    "    # Convert the date column to datetime if it's not already\n",
    "    df['Date'] = pd.to_datetime(df['Date'])\n",
    "\n",
    "    # Create a mask for tickers with 0 or NaN values between Jan 1, 2022, and Dec 30, 2022\n",
    "    mask = ((df['Date'] >= '2022-01-01') & (df['Date'] <= '2022-12-30')) & (df.isin([np.nan]).any(axis=1))\n",
    "\n",
    "    # Get tickers to filter out\n",
    "    tickers_to_filter = df[mask]['Ticker'].unique()\n",
    "\n",
    "    # Filter the DataFrame to exclude rows with tickers having 0 or NaN values\n",
    "    filtered_df = df[~df['Ticker'].isin(tickers_to_filter)]\n",
    "    \n",
    "    # Convert the date column to datetime if it's not already\n",
    "    filtered_df['Date'] = pd.to_datetime(filtered_df['Date'])\n",
    "\n",
    "    # Use pivot_table with aggregation (mean) to handle duplicates\n",
    "    pivot_df = filtered_df.pivot_table(index='Date', columns='Ticker', values='Returns', aggfunc='mean')\n",
    "\n",
    "    matrix_data = pivot_df.values\n",
    "    \n",
    "    return matrix_data"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 208,
   "id": "149d9196-7602-410c-97e1-264e32f1b88c",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\joshl\\AppData\\Local\\Temp/ipykernel_39852/262536465.py:16: SettingWithCopyWarning: \n",
      "A value is trying to be set on a copy of a slice from a DataFrame.\n",
      "Try using .loc[row_indexer,col_indexer] = value instead\n",
      "\n",
      "See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n",
      "  filtered_df['Date'] = pd.to_datetime(filtered_df['Date'])\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[[-0.018541  0.013092 -0.014851 ...  0.035998  0.048611  0.032096]\n",
      " [-0.033806 -0.046885  0.007817 ... -0.045936 -0.023179 -0.025267]\n",
      " [-0.017131  0.01773  -0.00277  ... -0.067901 -0.091525  0.02991 ]\n",
      " ...\n",
      " [-0.009763 -0.023629 -0.004726 ...  0.        0.0314    0.008721]\n",
      " [ 0.020258  0.063014  0.005866 ...  0.042724  0.099283 -0.00072 ]\n",
      " [-0.008042 -0.023411  0.004721 ...  0.006402 -0.065091  0.002884]]\n"
     ]
    }
   ],
   "source": [
    "matrix_data_unfiltered = convert(df)\n",
    "print(matrix_data_unfiltered)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 209,
   "id": "2ac316a9-bc30-4abc-b211-227056f5841a",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "251\n",
      "9418\n"
     ]
    }
   ],
   "source": [
    "for i in range(len(matrix_data_unfiltered[0]):\n",
    "    if"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 210,
   "id": "0252c85d-24f2-41f1-bee3-e18a56e84c6a",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[[0.00010618]\n",
      " [0.00010618]\n",
      " [0.00010618]\n",
      " ...\n",
      " [0.00010618]\n",
      " [0.00010618]\n",
      " [0.00010618]]\n"
     ]
    }
   ],
   "source": [
    "weight = np.full((9418, 1), 1/9418)\n",
    "print(weight)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 211,
   "id": "5db7637c-6030-489f-b361-93ee84ce7414",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "9418\n",
      "1\n"
     ]
    }
   ],
   "source": [
    "print(len(weight))\n",
    "print(len(weight[0]))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5396611d-9242-4acb-a0db-71f6e1ab9be6",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1c6f2387-26d4-407e-b9d1-502819a244ab",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8c8c9f08-71ae-45fb-842e-825c11bb9460",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.7"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
